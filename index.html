<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Massage barrel â€“ Roulette</title>
<style>
  :root{ --rose:#ff5ca8; --bleu:#3fa7ff; --bg:#0f1220; --text:#f5f7ff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;background:#0f1220;color:#f5f7ff;display:grid;place-items:center;min-height:100vh;padding:16px}
  .wrap{width:min(920px,95vw);display:grid;gap:16px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
  h1{margin:0 0 8px;font-size:1.25rem}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 320px}
  @media (max-width:880px){.grid{grid-template-columns:1fr}}
  .wheel-box{display:grid;place-items:center}
  .pointer{position:relative;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid #ffd166;margin-bottom:-8px;z-index:2}
  canvas{width:min(560px,90vw);height:auto;display:block;filter:drop-shadow(0 10px 20px rgba(0,0,0,.4));transition:transform 5.2s cubic-bezier(.12,.65,.06,1)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
  button{cursor:pointer;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#12162a;color:var(--text);padding:10px 14px;font-weight:600}
  .primary{background:linear-gradient(135deg,var(--bleu),var(--rose));color:#0b0b0f;border:none}
  textarea{width:100%;min-height:240px;border-radius:10px;background:#0e1120;color:var(--text);border:1px solid rgba(255,255,255,.15);padding:10px;line-height:1.5}
  .small{opacity:.8;font-size:.9rem}
  .result{margin-top:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);display:none}
  label{display:flex;gap:8px;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
  .swatch{width:14px;height:14px;border-radius:50%}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h1>Massage barrel</h1>
        <p class="small">
          Bleu = <b>Baptistou masse</b>, Rose = <b>Julitou masse</b>. Clique sur <b>Lancer</b>.
        </p>
        <div class="wheel-box">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="900" height="900" aria-label="Roue de massage"></canvas>
          <div class="controls">
            <button id="spin" class="primary">ðŸŽ¡ Lancer</button>
            <button id="reset">â†º RÃ©initialiser</button>
          </div>
          <div class="controls" style="margin-top:4px">
            <span class="chip"><span class="swatch" style="background:var(--bleu)"></span> Bleu&nbsp;: <b>Baptistou</b></span>
            <span class="chip"><span class="swatch" style="background:var(--rose)"></span> Rose&nbsp;: <b>Julitou</b></span>
          </div>
          <div id="out" class="result"></div>
        </div>
      </section>

      <aside class="card">
        <h2 style="margin:0 0 8px">Parties du corps</h2>
        <p class="small">Une par ligne. Clique <b>Actualiser</b>.</p>
        <textarea id="items">Ã‰paules
Nuque
Dos
Bras
Mains
Pieds
Jambes
Tempes
Visage
TÃªte
Mollets
Cuisses</textarea>
        <div class="controls" style="justify-content:space-between">
          <button id="apply">Actualiser</button>
          <label><input type="checkbox" id="invert"> Inverser rose/bleu</label>
        </div>
      </aside>
    </div>
  </div>

<script>
(function(){
  const NAME_BLUE = "Baptistou";
  const NAME_ROSE = "Julitou";

  const c = document.getElementById('wheel');
  const x = c.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  let items = [], invert=false, spinning=false, angle=0;

  function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
  const COLORS = {rose: css('--rose'), bleu: css('--bleu')};

  function readItems(){
    const v = document.getElementById('items').value.split('\n').map(s=>s.trim()).filter(Boolean);
    return v.length>=2 ? v : ['A','B'];
  }
  function colorAt(i){return (i%2===0) ^ invert ? COLORS.rose : COLORS.bleu;}

  function resize(){
    const size = Math.min(c.parentElement.clientWidth, 560);
    c.style.width = size+'px'; c.style.height = size+'px';
    c.width = Math.round(size*dpr); c.height = Math.round(size*dpr);
    draw();
  }

  function draw(){
    const W=c.width,H=c.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-8*dpr,rin=r*0.28;
    const seg = 2*Math.PI/items.length;
    x.clearRect(0,0,W,H);

    for(let i=0;i<items.length;i++){
      const a0=-Math.PI/2+i*seg, a1=a0+seg;
      // tranche
      x.beginPath(); x.moveTo(cx,cy); x.arc(cx,cy,r,a0,a1); x.closePath();
      x.fillStyle=colorAt(i); x.fill();

      // libellÃ© : ajustement auto (rÃ©duction + wrap 2 lignes max)
      const mid=a0+seg/2;
      x.save();
      const radiusText = rin + (r-rin)*0.62;
      x.translate(cx+Math.cos(mid)*radiusText, cy+Math.sin(mid)*radiusText);
      x.rotate(mid+Math.PI/2);
      x.fillStyle='#0b0b0f';
      const maxW = (r - rin) * 0.9;        // largeur max de texte
      const maxH = (r - rin) * 0.40;       // hauteur max pour 2 lignes
      let fs = Math.min(22, r*0.07) * dpr; // taille de base
      const minFs = 10*dpr;

      function wrapLines(txt, maxWidth){
        const words = txt.split(/\s+/);
        const lines = [];
        let line = "";
        for (const w of words){
          const test = line ? line + " " + w : w;
          if (x.measureText(test).width <= maxWidth) {
            line = test;
          } else {
            if (line) lines.push(line);
            line = w;
          }
        }
        if (line) lines.push(line);
        // si trop de lignes, regrouper la fin
        if (lines.length > 2) {
          const rest = lines.slice(1).join(' ');
          lines.length = 1;
          lines.push(rest);
        }
        return lines;
      }

      // trouver une taille de police qui rentre en 1â€“2 lignes et sous maxH
      let lines;
      do{
        x.font=`${fs}px system-ui,Segoe UI,Inter,Roboto,Arial`;
        lines = wrapLines(items[i], maxW);
        const lineHeight = fs*1.1;
        const totalH = lines.length * lineHeight;
        const tooWide = lines.some(t => x.measureText(t).width > maxW);
        if ((totalH > maxH || tooWide) && fs > minFs) fs -= 1*dpr; else break;
      }while(true);

      // si encore trop large, couper avec "â€¦"
      for (let j=0;j<lines.length;j++){
        while (x.measureText(lines[j]).width > maxW && fs > minFs){
          lines[j] = lines[j].slice(0, -1);
        }
        if (x.measureText(lines[j] + "â€¦").width <= maxW && j===lines.length-1 && items[i].length>lines.join(' ').length){
          lines[j] += "â€¦";
        }
      }

      const lh = fs*1.1;
      x.textAlign='center'; x.textBaseline='middle';
      for (let k=0;k<lines.length;k++){
        const y = (k - (lines.length-1)/2) * lh;
        x.fillText(lines[k], 0, y);
      }
      x.restore();

      // sÃ©parateur
      x.strokeStyle='rgba(255,255,255,.15)'; x.lineWidth=2*dpr;
      x.beginPath(); x.moveTo(cx,cy); x.lineTo(cx+Math.cos(a0)*r, cy+Math.sin(a0)*r); x.stroke();
    }

    // moyeu
    x.beginPath(); x.arc(cx,cy,rin,0,Math.PI*2); x.fillStyle='#fff'; x.fill();
    x.fillStyle='#11131e';
    x.font=`${Math.max(12,r*0.085)*dpr}px 700 system-ui,Segoe UI,Inter,Roboto`;
    x.textAlign='center'; x.textBaseline='middle';
    x.fillText('Massage barrel',cx,cy);
  }

  function setAngle(deg){angle=deg; c.style.transform=`rotate(${deg}deg)`;}

  function spin(){
    if(spinning) return; spinning=true; document.getElementById('out').style.display='none';
    const n=items.length, seg=360/n, idx=Math.floor(Math.random()*n), center=idx*seg+seg/2;
    const turns=5+Math.floor(Math.random()*3), final=turns*360+(360-center), jitter=(Math.random()-0.5)*6;
    c.style.transition='transform 5.2s cubic-bezier(.12,.65,.06,1)'; void c.offsetWidth; setAngle(final+jitter);
    const end=()=>{c.removeEventListener('transitionend',end); c.style.transition='transform .001s linear'; setAngle(final);
      setTimeout(()=>c.style.transition='transform 5.2s cubic-bezier(.12,.65,.06,1)',10);
      const col=colorAt(idx), part=items[idx], isBlue=(col.toLowerCase()===COLORS.bleu.toLowerCase());
      const out=document.getElementById('out'); out.style.display='block';
      out.innerHTML=`<b>${isBlue?NAME_BLUE:NAME_ROSE}</b> masse <b>${escape(part)}</b> â€” <span style="padding:2px 8px;border-radius:999px;background:${isBlue?'var(--bleu)':'var(--rose)'};color:#0b0b0f">${isBlue?'Bleu':'Rose'}</span>`;
      spinning=false;
    }; c.addEventListener('transitionend',end);
  }

  function escape(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function apply(){items=readItems(); draw(); setAngle(0); document.getElementById('out').style.display='none';}

  window.addEventListener('resize',resize,{passive:true});
  document.getElementById('spin').addEventListener('click',spin);
  document.getElementById('reset').addEventListener('click',()=>{if(!spinning){setAngle(0); document.getElementById('out').style.display='none';}});
  document.getElementById('apply').addEventListener('click',apply);
  document.getElementById('invert').addEventListener('change',e=>{invert=e.target.checked; draw();});

  items=readItems(); resize();
})();
</script>
</body>
</html>
