<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Massage barrel ‚Äì Roulette</title>

<!-- PWA / iOS -->
<meta name="theme-color" content="#0f1220" />
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --rose:#ff5ca8; --bleu:#3fa7ff; --ink:#0b0b0f; --text:#eef2ff; --muted:#9aa3b2;
    --bg:#0b0f1a; --card:#12182a; --ring: rgba(255,255,255,.12);
    --pad: max(16px, env(safe-area-inset-left));
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, Roboto, Segoe UI, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 80% -10%, #1e2746 0%, rgba(30,39,70,0) 60%),
      radial-gradient(900px 600px at 0% 100%, #242a4a 0%, rgba(36,42,74,0) 55%),
      var(--bg);
    padding: env(safe-area-inset-top) env(safe-area-inset-right) calc(env(safe-area-inset-bottom) + 8px) env(safe-area-inset-left);
  }

  /* Conteneur responsive, plus a√©r√© sur iPhone */
  .wrap{width:min(980px, 100%); margin:0 auto; padding:12px}
  .grid{display:grid; gap:14px; grid-template-columns: 1fr 340px}
  @media (max-width: 880px){ .grid{grid-template-columns: 1fr} }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border: 1px solid var(--ring);
    border-radius: 18px;
    padding: clamp(12px, 2.8vw, 18px);
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
  }

  /* Titre ‚Äúmoins typographique classique‚Äù, style moderne avec d√©grad√© */
  h1{
    margin:0 0 6px;
    font-weight:800;
    letter-spacing:.2px;
    font-size: clamp(22px, 4.8vw, 32px);
    line-height:1.15;
    background: linear-gradient(90deg, var(--bleu), var(--rose));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  h2{margin:0 0 8px; font-size: clamp(16px, 3.4vw, 20px)}
  .muted{color:var(--muted); font-size: clamp(13px, 3.2vw, 15px)}

  /* Zone roue, boutons + gros pour iPhone */
  .wheel-box{display:grid; place-items:center}
  .pointer{
    position:relative; width:0; height:0;
    border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:26px solid #ffd166;
    margin: 2px 0 -8px; filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
  }
  canvas{
    width: min(86vw, 560px); height: auto; display:block;
    filter: drop-shadow(0 12px 24px rgba(0,0,0,.4));
    transition: transform 5.2s cubic-bezier(.12,.65,.06,1);
    touch-action: manipulation;
  }
  .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px}
  button{
    appearance:none; border:1px solid var(--ring); background:#12162a; color:var(--text);
    border-radius: 14px; padding: 12px 16px; font-weight:700; font-size: clamp(14px, 3.8vw, 16px);
    cursor:pointer; min-width: 120px;
  }
  .primary{background: linear-gradient(135deg, var(--bleu), var(--rose)); color: var(--ink); border:none}
  button:active{transform:translateY(1px)}

  textarea{
    width:100%; min-height: 260px; resize: vertical;
    border-radius:14px; padding:12px; line-height:1.5;
    background:#0f1426; color:var(--text); border:1px solid var(--ring);
    font-size: clamp(14px, 3.6vw, 15px);
  }

  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
        background:rgba(255,255,255,.06); border:1px solid var(--ring); font-size: clamp(12px,3.2vw,14px)}
  .swatch{width:14px; height:14px; border-radius:50%}

  .result{
    margin-top:10px; padding:12px; border-radius:14px;
    background:rgba(255,255,255,.06); border:1px solid var(--ring);
    font-size: clamp(14px, 3.6vw, 16px);
  }

  /* Accessibilit√© / confort */
  @media (prefers-reduced-motion: reduce){
    canvas{transition: none;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h1>Massage barrel</h1>
        <p class="muted">Bleu = <b>Baptistou masse</b>, Rose = <b>Julitou masse</b>. Clique sur <b>Lancer</b>.</p>

        <div class="wheel-box">
          <div class="pointer" aria-hidden="true"></div>
          <canvas id="wheel" width="900" height="900" aria-label="Roue de massage"></canvas>

          <div class="controls">
            <button id="spin" class="primary">üé° Lancer</button>
            <button id="reset">‚Ü∫ R√©initialiser</button>
          </div>

          <div class="controls" style="margin-top:2px">
            <span class="chip"><span class="swatch" style="background:var(--bleu)"></span> Bleu&nbsp;: <b>Baptistou</b></span>
            <span class="chip"><span class="swatch" style="background:var(--rose)"></span> Rose&nbsp;: <b>Julitou</b></span>
          </div>

          <div id="out" class="result" style="display:none"></div>
        </div>
      </section>

      <aside class="card">
        <h2>Parties du corps</h2>
        <p class="muted">Une par ligne. Appuie sur <b>Actualiser</b>.</p>
        <textarea id="items">√âpaules
Nuque
Dos
Bras
Mains
Pieds
Jambes
Tempes
Visage
T√™te
Mollets
Cuisses</textarea>

        <div class="controls" style="justify-content:space-between">
          <button id="apply">Actualiser</button>
          <label class="muted" style="display:flex;gap:8px;align-items:center">
            <input id="invert" type="checkbox"> Inverser rose/bleu
          </label>
        </div>
      </aside>
    </div>
  </div>

<script>
(function(){
  const NAME_BLUE = "Baptistou";
  const NAME_ROSE = "Julitou";

  // PWA SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  const c = document.getElementById('wheel');
  const x = c.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  let items=[], invert=false, spinning=false, angle=0;

  function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
  const COLORS = {rose: css('--rose'), bleu: css('--bleu')};

  function readItems(){
    const v = document.getElementById('items').value.split('\n').map(s=>s.trim()).filter(Boolean);
    return v.length>=2 ? v : ['A','B'];
  }
  function colorAt(i){ return (i%2===0) ^ invert ? COLORS.rose : COLORS.bleu; }

  // Canvas HiDPI + taille mobile optimis√©e
  function resize(){
    const size = Math.min(c.parentElement.clientWidth, 560);
    c.style.width = size+'px'; c.style.height = size+'px';
    c.width = Math.round(size*dpr); c.height = Math.round(size*dpr);
    draw();
  }

  // ‚Äî‚Äî Dessin avec meilleur fit du texte pour iPhone ‚Äî‚Äî
  function draw(){
    const W=c.width,H=c.height,cx=W/2,cy=H/2;
    const r=Math.min(W,H)/2 - 10*dpr;
    const rin = r*0.26; // hub un peu plus petit -> + d'espace pour le texte
    const seg = 2*Math.PI/items.length;

    x.clearRect(0,0,W,H);

    for(let i=0;i<items.length;i++){
      const a0=-Math.PI/2+i*seg, a1=a0+seg;
      // tranche
      x.beginPath(); x.moveTo(cx,cy); x.arc(cx,cy,r,a0,a1); x.closePath();
      x.fillStyle=colorAt(i); x.fill();

      // ‚Äî‚Äî Label : multi-lignes + auto-r√©duction + ellipse (mieux sur iPhone) ‚Äî‚Äî
      const mid=a0+seg/2;
      x.save();
      const radiusText = rin + (r-rin)*0.60;          // position du texte
      x.translate(cx+Math.cos(mid)*radiusText, cy+Math.sin(mid)*radiusText);
      x.rotate(mid+Math.PI/2);
      x.fillStyle = '#0b0b0f';

      // contraintes adaptatives (un poil plus strictes sur petits √©crans)
      const span = (r - rin);
      const maxW = span * 0.92;
      const maxH = span * 0.46; // autorise 2 lignes confort
      let fs = Math.min(22, r*0.075) * dpr; // taille de d√©part
      const minFs = 9.5 * dpr;

      function wrapLines(txt, maxWidth){
        const words = txt.split(/\s+/);
        const lines = [];
        let line = "";
        for (const w of words){
          const test = line ? line + " " + w : w;
          if (x.measureText(test).width <= maxWidth) line = test;
          else { if (line) lines.push(line); line = w; }
        }
        if (line) lines.push(line);
        if (lines.length > 2){ // condense
          const rest = lines.slice(1).join(' ');
          lines.length = 1; lines.push(rest);
        }
        return lines;
      }

      let lines;
      do{
        x.font = `${fs}px -apple-system, Segoe UI, Inter, Roboto, Arial`;
        lines = wrapLines(items[i], maxW);
        const lh = fs*1.08;
        const totalH = lines.length * lh;
        const tooWide = lines.some(t => x.measureText(t).width > maxW);
        if ((totalH > maxH || tooWide) && fs > minFs) fs -= 1*dpr; else break;
      }while(true);

      // ellipse si encore trop long
      for (let j=0;j<lines.length;j++){
        while (x.measureText(lines[j]).width > maxW && fs > minFs){
          lines[j] = lines[j].slice(0,-1);
        }
        if (j===lines.length-1){
          const full = items[i];
          const joined = lines.join(' ');
          if (full.length > joined.length && x.measureText(lines[j] + "‚Ä¶").width <= maxW){
            lines[j] += "‚Ä¶";
          }
        }
      }

      // rendu lignes centr√©es
      x.textAlign='center'; x.textBaseline='middle';
      const lh = fs*1.08;
      for (let k=0;k<lines.length;k++){
        const y = (k - (lines.length-1)/2) * lh;
        x.fillText(lines[k], 0, y);
      }
      x.restore();

      // s√©parateur
      x.strokeStyle='rgba(255,255,255,.15)'; x.lineWidth=2*dpr;
      x.beginPath(); x.moveTo(cx,cy); x.lineTo(cx+Math.cos(a0)*r, cy+Math.sin(a0)*r); x.stroke();
    }

    // moyeu
    x.beginPath(); x.arc(cx,cy,rin,0,Math.PI*2); x.fillStyle='#fff'; x.fill();
    x.fillStyle='#11131e';
    x.font=`${Math.max(12, r*0.085)*dpr}px 800 -apple-system, Inter, Segoe UI`;
    x.textAlign='center'; x.textBaseline='middle';
    x.fillText('Massage barrel', cx, cy);
  }

  function setAngle(deg){ angle=deg; c.style.transform = `rotate(${deg}deg)`; }

  function spin(){
    if(spinning) return; spinning=true; document.getElementById('out').style.display='none';
    const n=items.length, seg=360/n, idx=Math.floor(Math.random()*n), center=idx*seg+seg/2;
    const turns = 5 + Math.floor(Math.random()*3);
    const final = turns*360 + (360 - center);
    const jitter=(Math.random()-0.5)*6;

    c.style.transition='transform 5.2s cubic-bezier(.12,.65,.06,1)'; void c.offsetWidth; setAngle(final+jitter);

    const end=()=>{
      c.removeEventListener('transitionend',end);
      c.style.transition='transform .001s linear'; setAngle(final);
      setTimeout(()=> c.style.transition='transform 5.2s cubic-bezier(.12,.65,.06,1)', 10);

      const col = colorAt(idx), part = items[idx];
      const isBlue = col.toLowerCase() === css('--bleu').toLowerCase();
      const out = document.getElementById('out');
      out.style.display='block';
      out.innerHTML = `<b>${isBlue ? "Baptistou" : "Julitou"}</b> masse <b>${escapeHtml(part)}</b> ‚Äî `
        + `<span class="chip"><span class="swatch" style="background:${isBlue?'var(--bleu)':'var(--rose)'}"></span>${isBlue?'Bleu':'Rose'}</span>`;
      // petite vibration (iOS la r√©duit)
      if (navigator.vibrate) navigator.vibrate(10);
      spinning=false;
    };
    c.addEventListener('transitionend', end);
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function apply(){ items=readItems(); draw(); setAngle(0); document.getElementById('out').style.display='none'; }

  // √âv√©nements
  window.addEventListener('resize', resize, {passive:true});
  document.getElementById('spin').addEventListener('click', spin);
  document.getElementById('reset').addEventListener('click', ()=>{ if(!spinning){ setAngle(0); document.getElementById('out').style.display='none'; }});
  document.getElementById('apply').addEventListener('click', apply);
  document.getElementById('invert').addEventListener('change', e=>{ invert=e.target.checked; draw(); });

  // Init
  items = readItems(); resize();
})();
</script>
</body>
</html>
